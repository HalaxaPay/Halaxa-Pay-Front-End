<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password | Halaxa Pay</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900,700,500,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: #f7f9fa;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Satoshi', sans-serif;
            position: relative;
            overflow: hidden;
        }

        /* Floating particles background */
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #2ECC71;
            border-radius: 50%;
            opacity: 0.3;
            animation: floatParticle 15s infinite linear;
        }

        .particle:nth-child(1) { left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 20%; animation-delay: 2s; }
        .particle:nth-child(3) { left: 30%; animation-delay: 4s; }
        .particle:nth-child(4) { left: 40%; animation-delay: 6s; }
        .particle:nth-child(5) { left: 50%; animation-delay: 8s; }
        .particle:nth-child(6) { left: 60%; animation-delay: 10s; }
        .particle:nth-child(7) { left: 70%; animation-delay: 12s; }
        .particle:nth-child(8) { left: 80%; animation-delay: 14s; }

        @keyframes floatParticle {
            0% {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 0.3;
                transform: scale(1);
            }
            90% {
                opacity: 0.3;
            }
            100% {
                transform: translateY(-100vh) scale(0);
                opacity: 0;
            }
        }

        .change-card {
            background: linear-gradient(135deg, #f8fffe 0%, #f7f9fa 100%);
            box-shadow: 0 8px 32px rgba(46,204,113,0.10), 0 1.5px 8px rgba(52,152,219,0.08);
            border-radius: 2rem;
            padding: 3.5rem 2.5rem 2.5rem 2.5rem;
            max-width: 370px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .change-card .icon {
            font-size: 2.8rem;
            color: #2ECC71;
            margin-bottom: 1.2rem;
            background: linear-gradient(135deg, #2ECC71 0%, #3498DB 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: block;
        }

        .change-card h1 {
            font-size: 2.1rem;
            font-weight: 900;
            margin: 0 0 0.3rem 0;
            background: linear-gradient(90deg, #2ECC71 0%, #3498DB 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        .change-card .subtitle {
            color: #6b7280;
            font-size: 1.08rem;
            margin-bottom: 2.2rem;
            text-align: center;
            font-weight: 500;
        }

        .change-card .form-title {
            font-size: 1.35rem;
            font-weight: 700;
            color: #1a1d29;
            margin-bottom: 0.7rem;
            text-align: center;
            letter-spacing: -0.5px;
        }

        .change-card .tip {
            font-size: 0.98rem;
            color: #3498DB;
            background: #ecfdf5;
            border-radius: 0.7rem;
            padding: 0.7rem 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 500;
        }

        .change-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            color: #1a1d29;
            font-weight: 600;
            font-size: 1.08rem;
            margin-bottom: 0.2rem;
        }

        .form-group input[type="password"] {
            padding: 1.1rem 1.1rem;
            border: 2px solid #e5f3f0;
            border-radius: 1.1rem;
            font-size: 1.08rem;
            background: #fff;
            color: #1a1d29;
            transition: border 0.2s;
        }

        .form-group input[type="password"]:focus {
            outline: none;
            border-color: #2ECC71;
            background: #f8fffe;
        }

        .form-group input[type="password"].error {
            border-color: #ef4444;
        }

        .form-group input[type="password"].success {
            border-color: #2ECC71;
        }

        .password-requirements {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.3rem;
        }

        .requirement {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-bottom: 0.2rem;
        }

        .requirement.valid {
            color: #2ECC71;
        }

        .requirement.invalid {
            color: #ef4444;
        }

        .change-button {
            width: 100%;
            padding: 1.1rem 0;
            background: linear-gradient(90deg, #2ECC71 0%, #3498DB 100%);
            color: #fff;
            border: none;
            border-radius: 1.1rem;
            font-size: 1.15rem;
            font-weight: 800;
            cursor: pointer;
            margin-top: 0.2rem;
            margin-bottom: 0.2rem;
            box-shadow: 0 2px 12px rgba(46,204,113,0.08);
            letter-spacing: 0.5px;
            transition: filter 0.2s, box-shadow 0.2s;
        }

        .change-button:hover:not(:disabled) {
            filter: brightness(1.08);
            box-shadow: 0 4px 24px rgba(52,152,219,0.13);
        }

        .change-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .message {
            width: 100%;
            text-align: center;
            font-size: 1.01rem;
            margin-bottom: 0.7rem;
            display: none;
        }

        .message.success { 
            color: #2ECC71; 
            display: block; 
        }

        .message.error { 
            color: #ef4444; 
            display: block; 
        }

        .contact {
            margin-top: 2.2rem;
            text-align: center;
            font-size: 0.99rem;
            color: #6b7280;
        }

        .contact strong {
            color: #2ECC71;
            font-weight: 700;
        }

        .contact a {
            color: #3498DB;
            text-decoration: underline;
            font-weight: 600;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .change-card {
                padding: 2.2rem 0.7rem 1.5rem 0.7rem;
                border-radius: 1.1rem;
                max-width: 98vw;
            }
            .change-card h1 {
                font-size: 1.4rem;
            }
            .change-card .form-title {
                font-size: 1.1rem;
            }
            .change-button {
                font-size: 1rem;
                padding: 0.9rem 0;
            }
        }
    </style>
</head>
<body>
    <!-- Floating particles background -->
    <div class="floating-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="change-card">
        <span class="icon"><i class="fas fa-key"></i></span>
        <h1>Halaxa Pay</h1>
        <div class="subtitle">Change your password</div>
        <div class="form-title">Set your new password</div>
        <div class="tip">Enter your new password below. Make sure it's secure and memorable.</div>
        
        <form id="changeForm" class="change-form" autocomplete="off" style="display: none;">
            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" name="newPassword" placeholder="Enter your new password" required>
                <div class="password-requirements">
                    <div class="requirement" id="length-req">
                        <i class="fas fa-circle"></i> At least 8 characters
                    </div>
                    <div class="requirement" id="uppercase-req">
                        <i class="fas fa-circle"></i> One uppercase letter
                    </div>
                    <div class="requirement" id="lowercase-req">
                        <i class="fas fa-circle"></i> One lowercase letter
                    </div>
                    <div class="requirement" id="number-req">
                        <i class="fas fa-circle"></i> One number
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="confirmPassword">Confirm New Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm your new password" required>
            </div>
            
            <button type="submit" class="change-button" id="changeButton">
                <span class="loading-spinner" id="loadingSpinner"></span>
                CHANGE PASSWORD
            </button>
            <div class="message" id="changeMessage"></div>
        </form>

        <div id="errorContainer" style="display: none;">
            <div class="message error" id="errorMessage"></div>
            <div class="contact">
                <div>Need help? Contact us at <a href="mailto:HalaxaPay@gmail.com">HalaxaPay@gmail.com</a></div>
                <div style="margin-top:0.5rem; color:#9ca3af; font-size:0.93rem;">We care about your security. Your password is never shared with anyone.</div>
            </div>
        </div>

        <div class="contact" id="successContainer" style="display: none;">
            <div>Need help? Contact us at <a href="mailto:HalaxaPay@gmail.com">HalaxaPay@gmail.com</a></div>
            <div style="margin-top:0.5rem; color:#9ca3af; font-size:0.93rem;">We care about your security. Your password is never shared with anyone.</div>
        </div>
    </div>

    <script>
        // Global variables for DOM elements
        const changeForm = document.getElementById('changeForm');
        const changeMessage = document.getElementById('changeMessage');
        const changeButton = document.getElementById('changeButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const successContainer = document.getElementById('successContainer');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');

        // Backend URL configuration
        const BACKEND_URL = 'https://halaxa-backend.onrender.com';

        // Password validation requirements
        const passwordRequirements = {
            length: { regex: /.{8,}/, element: document.getElementById('length-req') },
            uppercase: { regex: /[A-Z]/, element: document.getElementById('uppercase-req') },
            lowercase: { regex: /[a-z]/, element: document.getElementById('lowercase-req') },
            number: { regex: /[0-9]/, element: document.getElementById('number-req') }
        };

        // Extract token from URL parameters
        function getTokenFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }

        // Validate password requirements
        function validatePassword(password) {
            let isValid = true;
            
            // Check each requirement
            Object.keys(passwordRequirements).forEach(req => {
                const requirement = passwordRequirements[req];
                const isMet = requirement.regex.test(password);
                
                if (isMet) {
                    requirement.element.classList.add('valid');
                    requirement.element.classList.remove('invalid');
                    requirement.element.querySelector('i').className = 'fas fa-check';
                } else {
                    requirement.element.classList.add('invalid');
                    requirement.element.classList.remove('valid');
                    requirement.element.querySelector('i').className = 'fas fa-circle';
                    isValid = false;
                }
            });
            
            return isValid;
        }

        // Check if passwords match
        function passwordsMatch() {
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            return newPassword === confirmPassword && newPassword.length > 0;
        }

        // Update password input styling based on validation
        function updatePasswordValidation() {
            const newPassword = newPasswordInput.value;
            const isValid = validatePassword(newPassword);
            const matches = passwordsMatch();
            
            // Update new password input styling
            newPasswordInput.classList.remove('error', 'success');
            if (newPassword.length > 0) {
                newPasswordInput.classList.add(isValid ? 'success' : 'error');
            }
            
            // Update confirm password input styling
            confirmPasswordInput.classList.remove('error', 'success');
            if (confirmPasswordInput.value.length > 0) {
                confirmPasswordInput.classList.add(matches ? 'success' : 'error');
            }
            
            // Enable/disable submit button
            changeButton.disabled = !(isValid && matches);
        }

        // Validate token with backend
        async function validateToken(token) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/auth/validate-reset-token?token=${encodeURIComponent(token)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                return response.ok ? { valid: true, data } : { valid: false, error: data.error || 'Invalid token' };
            } catch (error) {
                console.error('Token validation error:', error);
                return { valid: false, error: 'Network error. Please try again.' };
            }
        }

        // Change password API call
        async function changePassword(token, newPassword) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/auth/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ token, newPassword })
                });
                
                const data = await response.json();
                return response.ok ? { success: true, data } : { success: false, error: data.error || 'Failed to change password' };
            } catch (error) {
                console.error('Password change error:', error);
                return { success: false, error: 'Network error. Please try again.' };
            }
        }

        // Show error message and hide form
        function showError(message) {
            errorMessage.textContent = message;
            errorContainer.style.display = 'block';
            changeForm.style.display = 'none';
            successContainer.style.display = 'none';
        }

        // Show success message and redirect
        function showSuccess(message) {
            changeMessage.textContent = message;
            changeMessage.className = 'message success';
            changeMessage.style.display = 'block';
            changeForm.style.display = 'none';
            errorContainer.style.display = 'none';
            successContainer.style.display = 'block';
            
            // Redirect to login page after 3 seconds
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 3000);
        }

        // Initialize page
        async function initializePage() {
            const token = getTokenFromURL();
            
            if (!token) {
                showError('Invalid or missing token. Please use the link from your email.');
                return;
            }
            
            // Validate token with backend
            const validationResult = await validateToken(token);
            
            if (!validationResult.valid) {
                showError(validationResult.error);
                return;
            }
            
            // Token is valid, show the form
            changeForm.style.display = 'flex';
            errorContainer.style.display = 'none';
        }

        // Event listeners
        newPasswordInput.addEventListener('input', updatePasswordValidation);
        confirmPasswordInput.addEventListener('input', updatePasswordValidation);

        changeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const token = getTokenFromURL();
            const newPassword = newPasswordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();
            
            // Final validation
            if (!validatePassword(newPassword)) {
                changeMessage.textContent = 'Please ensure your password meets all requirements.';
                changeMessage.className = 'message error';
                changeMessage.style.display = 'block';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                changeMessage.textContent = 'Passwords do not match.';
                changeMessage.className = 'message error';
                changeMessage.style.display = 'block';
                return;
            }
            
            // Disable button and show loading
            changeButton.disabled = true;
            loadingSpinner.style.display = 'inline-block';
            changeButton.textContent = 'CHANGING PASSWORD...';
            changeMessage.style.display = 'none';
            
            try {
                const result = await changePassword(token, newPassword);
                
                if (result.success) {
                    showSuccess(result.data.message || 'Password changed successfully! Redirecting to login...');
                } else {
                    changeMessage.textContent = result.error;
                    changeMessage.className = 'message error';
                    changeMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Password change error:', error);
                changeMessage.textContent = 'An unexpected error occurred. Please try again.';
                changeMessage.className = 'message error';
                changeMessage.style.display = 'block';
            } finally {
                // Re-enable button and hide loading
                changeButton.disabled = false;
                loadingSpinner.style.display = 'none';
                changeButton.textContent = 'CHANGE PASSWORD';
            }
        });

        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html> 